@using EvoAITest.Core.Models.Recording
@using EvoAITest.Core.Models.Execution
@using EvoAITest.Core.Abstractions
@using Microsoft.AspNetCore.SignalR.Client
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@implements IAsyncDisposable

<style>
    .test-preview-container {
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .streaming-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #e3f2fd;
        border-radius: 4px;
        margin: 10px 0;
    }

    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid #1976d2;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .streaming-text {
        color: #1976d2;
        font-weight: 500;
    }

    .streaming-output {
        margin: 20px 0;
        padding: 15px;
        background: #f5f5f5;
        border-left: 4px solid #4caf50;
        border-radius: 4px;
    }

    .streaming-output h4 {
        margin: 0 0 10px 0;
        color: #4caf50;
    }

    .streaming-output pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .execution-result {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 20px;
    }

    .result-summary {
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid;
    }

    .result-summary.passed {
        background: #d4edda;
        border-color: #28a745;
    }

    .result-summary.failed {
        background: #f8d7da;
        border-color: #dc3545;
    }

    .result-header {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .result-icon {
        font-size: 24px;
    }

    .result-status {
        font-size: 18px;
        text-transform: uppercase;
    }

    .result-duration {
        margin-left: auto;
        color: #666;
    }

    .result-details {
        margin: 10px 0;
    }

    .error-message {
        background: #fff;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        color: #dc3545;
        font-size: 12px;
    }

    .result-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
</style>

<div class="test-preview-container">
    <div class="preview-header">
        <h3>Generated Test Preview</h3>
        
        @* Streaming progress indicator *@
        @if (isStreaming)
        {
            <div class="streaming-indicator">
                <span class="spinner"></span>
                <span class="streaming-text">Generating test in real-time...</span>
            </div>
        }
        
        <div class="preview-actions">
            @if (GeneratedTest != null)
            {
                <button class="btn btn-secondary" @onclick="CopyToClipboard">
                    <span class="icon">??</span> Copy
                </button>
                <button class="btn btn-primary" @onclick="DownloadTest">
                    <span class="icon">??</span> Download
                </button>
                <button class="btn btn-success" @onclick="RunTest" disabled="@isExecutingTest">
                    <span class="icon">??</span> @(isExecutingTest ? "Running..." : "Run Test")
                </button>
                @if (OnEditRequested.HasDelegate)
                {
                    <button class="btn btn-info" @onclick="() => OnEditRequested.InvokeAsync(GeneratedTest)">
                        <span class="icon">??</span> Edit
                    </button>
                }
            }
            
            @* Streaming control buttons *@
            @if (Session != null)
            {
                @if (!isStreaming && streamingSupported)
                {
                    <button class="btn btn-success" @onclick="StartStreamingGeneration">
                        <span class="icon">??</span> Stream Generate
                    </button>
                }
                else if (isStreaming)
                {
                    <button class="btn btn-danger" @onclick="StopStreaming">
                        <span class="icon">??</span> Stop
                    </button>
                }
            }
        </div>
    </div>
    
    @* Streaming output area *@
    @if (isStreaming && !string.IsNullOrEmpty(streamingContent))
    {
        <div class="streaming-output">
            <h4>Live Generation:</h4>
            <pre><code>@streamingContent</code></pre>
        </div>
    }

    @if (GeneratedTest == null)
    {
        <div class="no-test-message">
            <p>No test has been generated yet.</p>
            <p class="hint">Complete a recording and generate a test to see the preview here.</p>
        </div>
    }
    else
    {
        <!-- Test Metadata -->
        <div class="test-metadata">
            <div class="metadata-row">
                <div class="metadata-item">
                    <span class="label">Class:</span>
                    <span class="value">@GeneratedTest.ClassName</span>
                </div>
                <div class="metadata-item">
                    <span class="label">Framework:</span>
                    <span class="value">@Session?.TestFramework</span>
                </div>
                <div class="metadata-item">
                    <span class="label">Methods:</span>
                    <span class="value">@GeneratedTest.Methods.Count</span>
                </div>
                <div class="metadata-item">
                    <span class="label">Assertions:</span>
                    <span class="value">@GeneratedTest.Metrics.AssertionCount</span>
                </div>
            </div>
        </div>

        <!-- Quality Metrics -->
        <div class="quality-metrics">
            <h4>Quality Metrics</h4>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">@GeneratedTest.Metrics.LinesOfCode</div>
                    <div class="metric-label">Lines of Code</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">@GeneratedTest.Metrics.MaintainabilityScore.ToString("F0")</div>
                    <div class="metric-label">Maintainability</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">@GeneratedTest.Metrics.EstimatedCoverage.ToString("F0")%</div>
                    <div class="metric-label">Coverage Est.</div>
                </div>
            </div>
        </div>

        <!-- Code Tabs -->
        <div class="code-tabs">
            <div class="tab-buttons">
                <button class="tab-button @(activeTab == "test" ? "active" : "")" 
                        @onclick='() => activeTab = "test"'>
                    Test Code
                </button>
                <button class="tab-button @(activeTab == "methods" ? "active" : "")" 
                        @onclick='() => activeTab = "methods"'>
                    Methods (@GeneratedTest.Methods.Count)
                </button>
                @if (GeneratedTest.PageObjects.Any())
                {
                    <button class="tab-button @(activeTab == "pageobjects" ? "active" : "")" 
                            @onclick='() => activeTab = "pageobjects"'>
                        Page Objects (@GeneratedTest.PageObjects.Count)
                    </button>
                }
                <button class="tab-button @(activeTab == "actions" ? "active" : "")" 
                        @onclick='() => activeTab = "actions"'>
                    Action Mapping
                </button>
            </div>

            <div class="tab-content">
                @if (activeTab == "test")
                {
                    <div class="code-viewer">
                        <pre><code class="language-csharp">@GeneratedTest.Code</code></pre>
                    </div>
                }
                else if (activeTab == "methods")
                {
                    <div class="methods-list">
                        @foreach (var method in GeneratedTest.Methods)
                        {
                            <div class="method-item">
                                <div class="method-header">
                                    <h5>@method.Name</h5>
                                    @if (!string.IsNullOrEmpty(method.Description))
                                    {
                                        <p class="method-description">@method.Description</p>
                                    }
                                </div>
                                <div class="code-viewer">
                                    <pre><code class="language-csharp">@method.Code</code></pre>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (activeTab == "pageobjects")
                {
                    <div class="pageobjects-list">
                        @foreach (var po in GeneratedTest.PageObjects)
                        {
                            <div class="pageobject-item">
                                <div class="pageobject-header">
                                    <h5>@po.ClassName</h5>
                                    @if (!string.IsNullOrEmpty(po.UrlPattern))
                                    {
                                        <p class="pageobject-url">@po.UrlPattern</p>
                                    }
                                </div>
                                <div class="code-viewer">
                                    <pre><code class="language-csharp">@po.Code</code></pre>
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (activeTab == "actions")
                {
                    <div class="action-mapping">
                        @if (Session != null)
                        {
                            @foreach (var interaction in Session.Interactions)
                            {
                                <div class="mapping-item">
                                    <div class="mapping-header">
                                        <span class="sequence">#@interaction.SequenceNumber</span>
                                        <span class="action-type">@interaction.ActionType</span>
                                        @if (!string.IsNullOrEmpty(interaction.Description))
                                        {
                                            <span class="description">@interaction.Description</span>
                                        }
                                    </div>
                                    @if (!string.IsNullOrEmpty(interaction.GeneratedCode))
                                    {
                                        <div class="mapping-code">
                                            <pre><code>@interaction.GeneratedCode</code></pre>
                                        </div>
                                    }
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="alert alert-info mt-3">
            @statusMessage
        </div>
    }

    @* Test execution result display *@
    @if (executionResult != null)
    {
        <div class="execution-result mt-3">
            <h4>Test Execution Result</h4>
            <div class="result-summary @GetResultCssClass(executionResult.Status)">
                <div class="result-header">
                    <span class="result-icon">@GetResultIcon(executionResult.Status)</span>
                    <span class="result-status">@executionResult.Status</span>
                    <span class="result-duration">@executionResult.DurationMs ms</span>
                </div>
                
                @if (executionResult.Status == TestExecutionStatus.Passed)
                {
                    <div class="result-details">
                        <p>? All @executionResult.TotalSteps steps passed</p>
                    </div>
                }
                else if (executionResult.Status == TestExecutionStatus.Failed)
                {
                    <div class="result-details">
                        <p>? @executionResult.FailedSteps of @executionResult.TotalSteps steps failed</p>
                        @if (!string.IsNullOrEmpty(executionResult.ErrorMessage))
                        {
                            <pre class="error-message">@executionResult.ErrorMessage</pre>
                        }
                    </div>
                }
                
                <div class="result-actions">
                    <button class="btn btn-sm btn-secondary" @onclick="ViewExecutionDetails">
                        View Details
                    </button>
                    <button class="btn btn-sm btn-primary" @onclick="RunTest">
                        Run Again
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string activeTab = "test";
    private string? statusMessage;
    private HubConnection? hubConnection;
    private bool isStreaming = false;
    private bool streamingSupported = true;
    private string streamingContent = string.Empty;
    private bool isExecutingTest = false;
    private TestExecutionResult? executionResult = null;

    [Parameter]
    public GeneratedTest? GeneratedTest { get; set; }

    [Parameter]
    public RecordingSession? Session { get; set; }

    [Parameter]
    public EventCallback<GeneratedTest> OnEditRequested { get; set; }

    [Inject]
    private HttpClient HttpClient { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await InitializeSignalRConnection();
    }

    private async Task InitializeSignalRConnection()
    {
        try
        {
            // Build SignalR connection to API service
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/hubs/llm-streaming"))
                .WithAutomaticReconnect()
                .Build();

            // Register handlers for streaming events
            hubConnection.On<EvoAITest.LLM.Models.LLMStreamChunk>("ReceiveToken", (chunk) =>
            {
                streamingContent += chunk.Delta;
                InvokeAsync(StateHasChanged);
            });

            hubConnection.On("StreamComplete", () =>
            {
                isStreaming = false;
                statusMessage = "Generation complete!";
                InvokeAsync(StateHasChanged);
            });

            hubConnection.On<object>("ReceiveError", (error) =>
            {
                isStreaming = false;
                statusMessage = $"Error: {error}";
                InvokeAsync(StateHasChanged);
            });

            // Start connection
            await hubConnection.StartAsync();
            streamingSupported = true;
        }
        catch (Exception ex)
        {
            streamingSupported = false;
            statusMessage = $"SignalR connection failed: {ex.Message}";
        }
    }

    private async Task StartStreamingGeneration()
    {
        if (Session == null || hubConnection == null || hubConnection.State != HubConnectionState.Connected)
        {
            return;
        }

        try
        {
            isStreaming = true;
            streamingContent = string.Empty;
            statusMessage = null;

            // Create LLM request for test generation
            var request = new EvoAITest.LLM.Models.LLMRequest
            {
                Model = "gpt-4",
                Messages = new List<EvoAITest.LLM.Models.Message>
                {
                    new() 
                    { 
                        Role = EvoAITest.LLM.Models.MessageRole.System, 
                        Content = "You are a test code generator." 
                    },
                    new() 
                    { 
                        Role = EvoAITest.LLM.Models.MessageRole.User, 
                        Content = $"Generate test code for recording: {Session.Name}" 
                    }
                }
            };

            // Invoke streaming method on hub
            await hubConnection.InvokeAsync("StreamCompletion", request);
        }
        catch (Exception ex)
        {
            isStreaming = false;
            statusMessage = $"Streaming failed: {ex.Message}";
        }
    }

    private async Task StopStreaming()
    {
        if (hubConnection != null && hubConnection.State == HubConnectionState.Connected)
        {
            await hubConnection.StopAsync();
            await InitializeSignalRConnection(); // Reconnect for next use
        }
        
        isStreaming = false;
    }

    private async Task RunTest()
    {
        if (Session == null)
        {
            statusMessage = "No recording session available";
            return;
        }

        try
        {
            isExecutingTest = true;
            statusMessage = "Executing test...";
            executionResult = null;
            StateHasChanged();

            // Call API to execute test from recording
            var response = await HttpClient.PostAsJsonAsync(
                $"/api/test-execution/recordings/{Session.Id}/execute",
                new
                {
                    TestFramework = Session.TestFramework,
                    Browser = Session.Browser,
                    Headless = true,
                    CaptureScreenshots = true
                });

            if (response.IsSuccessStatusCode)
            {
                executionResult = await response.Content.ReadFromJsonAsync<TestExecutionResult>();
                statusMessage = $"Test execution completed: {executionResult?.Status}";
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                statusMessage = $"Test execution failed: {error}";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error executing test: {ex.Message}";
        }
        finally
        {
            isExecutingTest = false;
            StateHasChanged();
        }
    }

    private void ViewExecutionDetails()
    {
        if (executionResult != null)
        {
            // Navigate to execution details page
            Navigation.NavigateTo($"/test-execution/results/{executionResult.Id}");
        }
    }

    private string GetResultCssClass(TestExecutionStatus status)
    {
        return status switch
        {
            TestExecutionStatus.Passed => "passed",
            TestExecutionStatus.Failed => "failed",
            TestExecutionStatus.CompilationError => "failed",
            _ => "running"
        };
    }

    private string GetResultIcon(TestExecutionStatus status)
    {
        return status switch
        {
            TestExecutionStatus.Passed => "?",
            TestExecutionStatus.Failed => "?",
            TestExecutionStatus.CompilationError => "??",
            TestExecutionStatus.Running => "?",
            _ => "?"
        };
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    private async Task CopyToClipboard()
    {
        if (GeneratedTest != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", GeneratedTest.Code);
                statusMessage = "Code copied to clipboard!";
                StateHasChanged();
                
                // Clear message after 3 seconds
                await Task.Delay(3000);
                statusMessage = string.Empty;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                statusMessage = $"Failed to copy: {ex.Message}";
            }
        }
    }

    private async Task DownloadTest()
    {
        if (GeneratedTest != null)
        {
            try
            {
                var fileName = $"{GeneratedTest.ClassName}.cs";
                var fileContent = GeneratedTest.Code;
                
                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, fileContent);
                statusMessage = $"Downloaded {fileName}";
                StateHasChanged();
                
                await Task.Delay(3000);
                statusMessage = string.Empty;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                statusMessage = $"Failed to download: {ex.Message}";
            }
        }
    }
}
