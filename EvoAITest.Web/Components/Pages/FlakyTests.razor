@page "/analytics/flaky-tests"
@using EvoAITest.Core.Models.Analytics
@inject HttpClient HttpClient
@inject NavigationManager Navigation

<PageTitle>Flaky Tests - EvoAITest</PageTitle>

<div class="flaky-tests-page">
    <div class="page-header">
        <div class="header-left">
            <h1>‚ö†Ô∏è Flaky Test Detection</h1>
            <p class="subtitle">Tests with inconsistent behavior and intermittent failures</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" @onclick="RefreshTests" disabled="@loading">
                <span class="icon">üîÑ</span> @(loading ? "Loading..." : "Refresh")
            </button>
            <button class="btn btn-secondary" @onclick='() => ExportFlakyTests("json")'>
                <span class="icon">üì•</span> Export JSON
            </button>
            <button class="btn btn-secondary" @onclick='() => ExportFlakyTests("csv")'>
                <span class="icon">üì•</span> Export CSV
            </button>
            <button class="btn btn-primary" @onclick="NavigateToDashboard">
                <span class="icon">üìä</span> Dashboard
            </button>
        </div>
    </div>

    @if (loading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Analyzing flaky tests...</p>
        </div>
    }
    else if (error != null)
    {
        <div class="alert alert-danger">
            <h4>Error Loading Flaky Tests</h4>
            <p>@error</p>
            <button class="btn btn-sm btn-secondary" @onclick="RefreshTests">Retry</button>
        </div>
    }
    else
    {
        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card">
                <div class="card-icon critical">‚ö†Ô∏è</div>
                <div class="card-content">
                    <div class="card-value">@flakyTests.Count(t => t.Severity == FlakinessSeverity.Critical)</div>
                    <div class="card-label">Critical</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-icon high">üî¥</div>
                <div class="card-content">
                    <div class="card-value">@flakyTests.Count(t => t.Severity == FlakinessSeverity.High)</div>
                    <div class="card-label">High</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-icon medium">üü°</div>
                <div class="card-content">
                    <div class="card-value">@flakyTests.Count(t => t.Severity == FlakinessSeverity.Medium)</div>
                    <div class="card-label">Medium</div>
                </div>
            </div>
            <div class="summary-card">
                <div class="card-icon low">üü¢</div>
                <div class="card-content">
                    <div class="card-value">@flakyTests.Count(t => t.Severity == FlakinessSeverity.Low)</div>
                    <div class="card-label">Low</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filter-group">
                <label>Severity Filter:</label>
                <select @bind="selectedSeverity" @bind:after="ApplyFilters" class="form-select">
                    <option value="">All Severities</option>
                    <option value="Critical">Critical</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Min Flakiness Score:</label>
                <input type="number" @bind="minScore" @bind:after="ApplyFilters" 
                       class="form-input" min="0" max="100" step="10" placeholder="0-100" />
            </div>

            <div class="filter-group">
                <label>Sort By:</label>
                <select @bind="sortBy" @bind:after="ApplyFilters" class="form-select">
                    <option value="score">Flakiness Score</option>
                    <option value="severity">Severity</option>
                    <option value="date">Analysis Date</option>
                    <option value="name">Test Name</option>
                </select>
            </div>

            @if (hasFilters)
            {
                <button class="btn btn-sm btn-outline" @onclick="ClearFilters">
                    Clear Filters
                </button>
            }
        </div>

        <!-- Flaky Tests List -->
        <div class="tests-container">
            @if (!filteredTests.Any())
            {
                <div class="empty-state">
                    <div class="empty-icon">üéâ</div>
                    <h3>No Flaky Tests Found!</h3>
                    <p>@(hasFilters ? "Try adjusting your filters." : "Your test suite is stable with no flaky tests detected.")</p>
                </div>
            }
            else
            {
                @foreach (var test in filteredTests)
                {
                    <div class="test-card @GetSeverityClass(test.Severity)">
                        <div class="test-header" @onclick="() => ToggleDetails(test.Id)">
                            <div class="test-title">
                                <span class="severity-badge @GetSeverityClass(test.Severity)">
                                    @GetSeverityIcon(test.Severity)
                                </span>
                                <h3>@test.TestName</h3>
                                <span class="chevron @(expandedTestIds.Contains(test.Id) ? "expanded" : "")">‚ñº</span>
                            </div>
                            <div class="test-meta">
                                <div class="meta-item">
                                    <span class="meta-label">Flakiness Score:</span>
                                    <span class="meta-value score">@test.FlakinessScore.ToString("F1")</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Pass Rate:</span>
                                    <span class="meta-value">@test.PassRate.ToString("F1")%</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Executions:</span>
                                    <span class="meta-value">@test.TotalExecutions</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Flaky Failures:</span>
                                    <span class="meta-value warning">@test.FlakyFailureCount</span>
                                </div>
                            </div>
                        </div>

                        @if (expandedTestIds.Contains(test.Id))
                        {
                            <div class="test-details">
                                <!-- Statistics -->
                                <div class="details-section">
                                    <h4>üìä Statistics</h4>
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <span class="stat-label">Consistent Passes:</span>
                                            <span class="stat-value">@test.ConsistentPassCount</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Consistent Failures:</span>
                                            <span class="stat-value">@test.ConsistentFailureCount</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Duration Variability:</span>
                                            <span class="stat-value">@test.DurationVariability.ToString("F2")</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Confidence:</span>
                                            <span class="stat-value">@test.AnalysisConfidence.ToString("F0")%</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Detected Patterns -->
                                @if (test.Patterns.Any())
                                {
                                    <div class="details-section">
                                        <h4>üîç Detected Patterns</h4>
                                        <div class="patterns-list">
                                            @foreach (var pattern in test.Patterns.OrderByDescending(p => p.Confidence))
                                            {
                                                <div class="pattern-item">
                                                    <div class="pattern-header">
                                                        <span class="pattern-type">@GetPatternIcon(pattern.Type) @pattern.Type</span>
                                                        <span class="pattern-confidence">
                                                            Confidence: @pattern.Confidence.ToString("F0")%
                                                        </span>
                                                    </div>
                                                    <p class="pattern-description">@pattern.Description</p>
                                                    <div class="pattern-meta">
                                                        <span>Occurrences: @pattern.Occurrences</span>
                                                        @if (!string.IsNullOrEmpty(pattern.SuggestedFix))
                                                        {
                                                            <span class="suggested-fix">üí° @pattern.SuggestedFix</span>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }

                                <!-- Root Causes -->
                                @if (test.RootCauses.Any())
                                {
                                    <div class="details-section">
                                        <h4>üéØ Identified Root Causes</h4>
                                        <div class="tags-list">
                                            @foreach (var cause in test.RootCauses)
                                            {
                                                <span class="tag tag-cause">@cause</span>
                                            }
                                        </div>
                                    </div>
                                }

                                <!-- Recommendations -->
                                @if (test.Recommendations.Any())
                                {
                                    <div class="details-section">
                                        <h4>üí° Recommendations</h4>
                                        <ul class="recommendations-list">
                                            @foreach (var recommendation in test.Recommendations)
                                            {
                                                <li>@recommendation</li>
                                            }
                                        </ul>
                                    </div>
                                }

                                <!-- Actions -->
                                <div class="details-section">
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-primary" 
                                                @onclick="() => ViewRecordingInsights(test.RecordingSessionId)">
                                            View Recording Insights
                                        </button>
                                        <button class="btn btn-sm btn-secondary" 
                                                @onclick="() => ViewExecutionHistory(test.RecordingSessionId)">
                                            View Execution History
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    private List<FlakyTestAnalysis> flakyTests = new();
    private List<FlakyTestAnalysis> filteredTests = new();
    private HashSet<Guid> expandedTestIds = new();
    private bool loading = true;
    private string? error = null;

    // Filters
    private string? selectedSeverity = null;
    private int? minScore = null;
    private string sortBy = "score";

    private bool hasFilters => !string.IsNullOrEmpty(selectedSeverity) || minScore.HasValue;

    protected override async Task OnInitializedAsync()
    {
        await LoadFlakyTests();
    }

    private async Task LoadFlakyTests()
    {
        try
        {
            loading = true;
            error = null;
            StateHasChanged();

            flakyTests = await HttpClient.GetFromJsonAsync<List<FlakyTestAnalysis>>("/api/analytics/flaky-tests") ?? new();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            error = $"Failed to load flaky tests: {ex.Message}";
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshTests()
    {
        await LoadFlakyTests();
    }

    private void ApplyFilters()
    {
        var query = flakyTests.AsEnumerable();

        // Apply severity filter
        if (!string.IsNullOrEmpty(selectedSeverity) && Enum.TryParse<FlakinessSeverity>(selectedSeverity, out var severity))
        {
            query = query.Where(t => t.Severity == severity);
        }

        // Apply min score filter
        if (minScore.HasValue)
        {
            query = query.Where(t => t.FlakinessScore >= minScore.Value);
        }

        // Apply sorting
        query = sortBy switch
        {
            "score" => query.OrderByDescending(t => t.FlakinessScore),
            "severity" => query.OrderByDescending(t => t.Severity).ThenByDescending(t => t.FlakinessScore),
            "date" => query.OrderByDescending(t => t.AnalyzedAt),
            "name" => query.OrderBy(t => t.TestName),
            _ => query.OrderByDescending(t => t.FlakinessScore)
        };

        filteredTests = query.ToList();
    }

    private void ClearFilters()
    {
        selectedSeverity = null;
        minScore = null;
        ApplyFilters();
    }

    private void ToggleDetails(Guid testId)
    {
        if (expandedTestIds.Contains(testId))
        {
            expandedTestIds.Remove(testId);
        }
        else
        {
            expandedTestIds.Add(testId);
        }
    }

    private void NavigateToDashboard()
    {
        Navigation.NavigateTo("/analytics/dashboard");
    }

    private void ViewRecordingInsights(Guid recordingId)
    {
        Navigation.NavigateTo($"/analytics/recordings/{recordingId}/insights");
    }

    private void ViewExecutionHistory(Guid recordingId)
    {
        Navigation.NavigateTo($"/test-execution/results");
    }

    private string GetSeverityClass(FlakinessSeverity severity)
    {
        return severity switch
        {
            FlakinessSeverity.Critical => "severity-critical",
            FlakinessSeverity.High => "severity-high",
            FlakinessSeverity.Medium => "severity-medium",
            FlakinessSeverity.Low => "severity-low",
            _ => "severity-none"
        };
    }

    private string GetSeverityIcon(FlakinessSeverity severity)
    {
        return severity switch
        {
            FlakinessSeverity.Critical => "üî¥",
            FlakinessSeverity.High => "üü†",
            FlakinessSeverity.Medium => "üü°",
            FlakinessSeverity.Low => "üü¢",
            _ => "‚ö™"
        };
    }

    private string GetPatternIcon(PatternType type)
    {
        return type switch
        {
            PatternType.Intermittent => "üîÑ",
            PatternType.Temporal => "‚è∞",
            PatternType.Sequential => "üî¢",
            PatternType.TimingDependent => "‚è±Ô∏è",
            PatternType.ResourceDependent => "üíæ",
            PatternType.EnvironmentSpecific => "üåç",
            PatternType.RunCount => "üîÅ",
            PatternType.Degrading => "üìâ",
            _ => "‚ùì"
        };
    }

    private void ExportFlakyTests(string format)
    {
        var url = $"/api/analytics/export/flaky-tests?format={format}";
        
        // Apply current filters to export
        if (!string.IsNullOrEmpty(selectedSeverity))
        {
            url += $"&severity={selectedSeverity}";
        }
        if (minScore.HasValue)
        {
            url += $"&minScore={minScore.Value}";
        }

        Navigation.NavigateTo(url, forceLoad: true);
    }
}

<style>
    .flaky-tests-page {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
    }

    .header-left h1 {
        margin: 0 0 5px 0;
        font-size: 32px;
        color: #333;
    }

    .subtitle {
        margin: 0;
        color: #666;
        font-size: 14px;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    .loading-container {
        text-align: center;
        padding: 60px 20px;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #dc3545;
        border-radius: 50%;
        margin: 0 auto 20px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Summary Cards */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .card-icon {
        font-size: 40px;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
    }

    .card-icon.critical {
        background: rgba(220, 53, 69, 0.1);
    }

    .card-icon.high {
        background: rgba(253, 126, 20, 0.1);
    }

    .card-icon.medium {
        background: rgba(255, 193, 7, 0.1);
    }

    .card-icon.low {
        background: rgba(40, 167, 69, 0.1);
    }

    .card-value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
    }

    .card-label {
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
    }

    /* Filters */
    .filters-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-size: 12px;
        font-weight: 500;
        color: #666;
        text-transform: uppercase;
    }

    .form-select, .form-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        min-width: 150px;
    }

    .form-input {
        min-width: 100px;
    }

    /* Test Cards */
    .tests-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .test-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
        border-left: 6px solid;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .test-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .test-card.severity-critical {
        border-color: #dc3545;
    }

    .test-card.severity-high {
        border-color: #fd7e14;
    }

    .test-card.severity-medium {
        border-color: #ffc107;
    }

    .test-card.severity-low {
        border-color: #28a745;
    }

    .test-header {
        padding: 20px;
        cursor: pointer;
        user-select: none;
    }

    .test-title {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }

    .test-title h3 {
        margin: 0;
        font-size: 20px;
        color: #333;
        flex: 1;
    }

    .severity-badge {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 18px;
        font-weight: 600;
    }

    .severity-badge.severity-critical {
        background: rgba(220, 53, 69, 0.1);
    }

    .severity-badge.severity-high {
        background: rgba(253, 126, 20, 0.1);
    }

    .severity-badge.severity-medium {
        background: rgba(255, 193, 7, 0.1);
    }

    .severity-badge.severity-low {
        background: rgba(40, 167, 69, 0.1);
    }

    .chevron {
        font-size: 16px;
        transition: transform 0.3s;
        color: #666;
    }

    .chevron.expanded {
        transform: rotate(180deg);
    }

    .test-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }

    .meta-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .meta-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
    }

    .meta-value {
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

    .meta-value.score {
        color: #dc3545;
    }

    .meta-value.warning {
        color: #ffc107;
    }

    /* Test Details */
    .test-details {
        padding: 20px;
        background: #f8f9fa;
        border-top: 1px solid #e0e0e0;
    }

    .details-section {
        margin-bottom: 25px;
    }

    .details-section:last-child {
        margin-bottom: 0;
    }

    .details-section h4 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background: white;
        border-radius: 4px;
    }

    .stat-label {
        font-size: 13px;
        color: #666;
    }

    .stat-value {
        font-weight: 600;
        color: #333;
    }

    /* Patterns */
    .patterns-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .pattern-item {
        background: white;
        padding: 15px;
        border-radius: 6px;
        border-left: 4px solid #007bff;
    }

    .pattern-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .pattern-type {
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }

    .pattern-confidence {
        font-size: 12px;
        color: #666;
    }

    .pattern-description {
        margin: 0 0 10px 0;
        color: #555;
        font-size: 14px;
    }

    .pattern-meta {
        display: flex;
        gap: 20px;
        font-size: 12px;
        color: #666;
    }

    .suggested-fix {
        color: #007bff;
        font-weight: 500;
    }

    /* Tags */
    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .tag {
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 13px;
        font-weight: 500;
    }

    .tag-cause {
        background: #e3f2fd;
        color: #1976d2;
    }

    /* Recommendations */
    .recommendations-list {
        margin: 0;
        padding-left: 20px;
    }

    .recommendations-list li {
        margin-bottom: 10px;
        color: #555;
        line-height: 1.6;
    }

    /* Actions */
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .empty-icon {
        font-size: 80px;
        margin-bottom: 20px;
    }

    .empty-state h3 {
        margin: 0 0 10px 0;
        color: #333;
    }

    .empty-state p {
        margin: 0;
        color: #666;
    }

    /* Buttons */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-outline {
        background: white;
        color: #007bff;
        border: 1px solid #007bff;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
    }

    .alert {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .alert-danger {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .icon {
        font-size: 16px;
    }
</style>
